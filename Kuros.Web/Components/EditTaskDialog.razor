@using Kuros.Core.DTOs.TaskItems
@inject ApiClient ApiClient

<div class="dialog-content">
    <h3>Edit Task</h3>
    <EditForm Model="@updateModel" OnValidSubmit="@HandleUpdate">
        <DataAnnotationsValidator />

        <div class="form-group">
            <label for="title">Task Title</label>
            <InputText id="title" @bind-Value="updateModel.Title" class="form-control" required
                placeholder="Enter task title" />
                <br>
            <label for="description">Task Description</label>
            <InputTextArea id="description" @bind-Value="updateModel.Description" class="form-control" rows="4"
                placeholder="Enter task description (optional)" />
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" @onclick="Cancel" disabled="@isSaving">Close</button>
            <button type="submit" class="btn btn-primary" disabled="@isSaving">
                @if (isSaving)
                {
                    <span>Updating...</span>
                }
                else
                {

                    <span>Update</span>
                }
            </button>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public TaskItemResponseDto? Task { get; set; }

    private TaskItemUpdateDto updateModel = new();
    private bool isSaving = false;

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback<TaskItemResponseDto> OnSuccess { get; set; }

    protected override void OnInitialized()
    {
        if (Task != null)
        {
            updateModel.Title = Task.Title;
        }
    }

    private async Task HandleUpdate()
    {
        if (Task == null) return;

        isSaving = true;

        var result = await ApiClient.UpdateTaskAsync(Task.Id, updateModel);

        if (result != null)
        {
            await OnSuccess.InvokeAsync(result);
        }

        isSaving = false;
        await OnClose.InvokeAsync();
    }

    private async Task Cancel()
    {
        await OnClose.InvokeAsync();
    }
}