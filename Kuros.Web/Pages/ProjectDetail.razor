@page "/project/{ProjectId:guid}"
@using Kuros.Core.DTOs.Projects
@using Kuros.Core.DTOs.TaskItems
@using Kuros.Core.Enums
@inject ApiClient ApiClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-8">
    <div class="project-header">
        <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack"
            OnClick="@(() => Navigation.NavigateTo("/dashboard"))">
            Back to Projects
        </MudButton>
        <div>
            <MudText Typo="Typo.h3" Class="mb-2">@project?.Name</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">@project?.Description</MudText>
        </div>
        <div class="project-actions">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large"
                StartIcon="@Icons.Material.Filled.Add" OnClick="@OpenCreateTaskDialog">
                New Task
            </MudButton>
            <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Large">
                <MudMenuItem OnClick="@OpenEditProjectDialog">Edit Project</MudMenuItem>
                <MudMenuItem OnClick="@DeleteProject">Delete Project</MudMenuItem>
            </MudMenu>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <MudProgressCircular Indeterminate="true" />
            <MudText Class="mt-4">Loading board...</MudText>
        </div>
    }
    else
    {
        <div class="kanban-board">
            @foreach (var status in TaskStatuses)
            {
                <div class="kanban-column" style="@GetColumnStyle(status)">
                    <div class="column-header">
                        <MudText Typo="Typo.h6" Class="column-title">@GetStatusLabel(status)</MudText>
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(status)">
                            @GetTasksForStatus(status).Count
                        </MudChip>
                    </div>

                    <div class="column-tasks">
                        @foreach (var task in GetTasksForStatus(status))
                        {
                            <MudCard Class="task-card">
                                <MudCardContent>
                                    <MudText Typo="Typo.body2" Class="task-title">@task.Title</MudText>
                                </MudCardContent>
                                <MudCardActions>
                                    <MudMenu Size="Size.Small" Icon="@Icons.Material.Filled.Edit">
                                        <MudMenuItem OnClick="@(() => OpenEditTaskDialog(task))">Edit</MudMenuItem>
                                        <MudMenuItem OnClick="@(() => DeleteTask(task.Id))">Delete</MudMenuItem>
                                        <MudDivider />
                                        @foreach (var moveStatus in TaskStatuses)
                                        {
                                            if (moveStatus != task.TaskItemStatus)
                                            {
                                                <MudMenuItem OnClick="@(() => MoveTask(task.Id, moveStatus))">
                                                    Move to @GetStatusLabel(moveStatus)
                                                </MudMenuItem>
                                            }
                                        }
                                    </MudMenu>
                                </MudCardActions>
                            </MudCard>
                        }
                    </div>
                </div>
            }
        </div>
    }
</MudContainer>

<style>
    .project-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 40px;
        flex-wrap: wrap;
    }

    .project-actions {
        display: flex;
        gap: 10px;
    }

    .kanban-board {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        min-height: 600px;
    }

    .kanban-column {
        border-radius: 8px;
        padding: 16px;
        min-height: 600px;
        border: 2px solid;
    }

    .column-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid;
    }

    .column-title {
        margin: 0;
        flex: 1;
    }

    .column-tasks {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .task-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        cursor: move;
        transition: all 0.2s ease;
    }

    .task-card:hover {
        box-shadow: 0 4px 12px rgba(100, 181, 246, 0.15);
        border-color: rgba(100, 181, 246, 0.3);
    }

    .task-title {
        word-break: break-word;
        color: #fff;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 600px;
    }

    @@media
    (max-width: 768px) {
        .project-header {
            flex-direction: column;
        }

        .kanban-board {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    [Parameter]
    public Guid ProjectId { get; set; }

    private ProjectResponseDto? project;
    private List<TaskItemResponseDto>? tasks;
    private bool isLoading = true;

    private readonly TaskItemStatus[] TaskStatuses =
    {
TaskItemStatus.BackLog,
TaskItemStatus.ToDo,
TaskItemStatus.InDevelopment,
TaskItemStatus.CodeReview,
TaskItemStatus.Done
};

    protected override async Task OnInitializedAsync()
    {
        await LoadProject();
        await LoadTasks();
    }

    private async Task LoadProject()
    {
        project = await ApiClient.GetProjectAsync(ProjectId);
    }

    private async Task LoadTasks()
    {
        isLoading = true;
        tasks = await ApiClient.GetTasksByProjectAsync(ProjectId);
        isLoading = false;
    }

    private List<TaskItemResponseDto> GetTasksForStatus(TaskItemStatus status)
    {
        return tasks?.Where(t => t.TaskItemStatus == status).ToList() ?? new();
    }

    private string GetStatusLabel(TaskItemStatus status) => status switch
    {
        TaskItemStatus.BackLog => "Backlog",
        TaskItemStatus.ToDo => "To Do",
        TaskItemStatus.InDevelopment => "In Development",
        TaskItemStatus.CodeReview => "Code Review",
        TaskItemStatus.Done => "Done",
        _ => status.ToString()
    };

    private Color GetStatusColor(TaskItemStatus status) => status switch
    {
        TaskItemStatus.BackLog => Color.Default,
        TaskItemStatus.ToDo => Color.Warning,
        TaskItemStatus.InDevelopment => Color.Info,
        TaskItemStatus.CodeReview => Color.Secondary,
        TaskItemStatus.Done => Color.Success,
        _ => Color.Default
    };

    private string GetColumnStyle(TaskItemStatus status) => status switch
    {
        TaskItemStatus.BackLog => "background: rgba(158, 158, 158, 0.1); border-color: #9e9e9e;",
        TaskItemStatus.ToDo => "background: rgba(255, 152, 0, 0.1); border-color: #ff9800;",
        TaskItemStatus.InDevelopment => "background: rgba(33, 150, 243, 0.1); border-color: #2196f3;",
        TaskItemStatus.CodeReview => "background: rgba(156, 39, 176, 0.1); border-color: #9c27b0;",
        TaskItemStatus.Done => "background: rgba(76, 175, 80, 0.1); border-color: #4caf50;",
        _ => ""
    };

    private async Task OpenCreateTaskDialog()
    {
        var parameters = new DialogParameters { { "ProjectId", ProjectId } };
        var dialog = await DialogService.ShowAsync<CreateTaskDialog>("Create New Task", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadTasks();
        }
    }

    private async Task OpenEditTaskDialog(TaskItemResponseDto task)
    {
        var parameters = new DialogParameters { { "Task", task } };
        var dialog = await DialogService.ShowAsync<EditTaskDialog>("Edit Task", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadTasks();
        }
    }

    private async Task OpenEditProjectDialog()
    {
        if (project == null) return;

        var parameters = new DialogParameters { { "Project", project } };
        var dialog = await DialogService.ShowAsync<EditProjectDialog>("Edit Project", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadProject();
        }
    }

    private async Task DeleteProject()
    {
        var result = await DialogService.ShowMessageBox(
        "Delete Project",
        "Are you sure you want to delete this project? This action cannot be undone.",
        yesText: "Delete", noText: "Cancel");

        if (result == true)
        {
            var success = await ApiClient.DeleteProjectAsync(ProjectId);
            if (success)
            {
                Snackbar.Add("Project deleted successfully", Severity.Success);
                Navigation.NavigateTo("/dashboard");
            }
            else
            {
                Snackbar.Add("Failed to delete project", Severity.Error);
            }
        }
    }

    private async Task DeleteTask(Guid taskId)
    {
        var result = await DialogService.ShowMessageBox(
        "Delete Task",
        "Are you sure you want to delete this task?",
        yesText: "Delete", noText: "Cancel");

        if (result == true)
        {
            var success = await ApiClient.DeleteTaskAsync(taskId);
            if (success)
            {
                Snackbar.Add("Task deleted successfully", Severity.Success);
                await LoadTasks();
            }
            else
            {
                Snackbar.Add("Failed to delete task", Severity.Error);
            }
        }
    }

    private async Task MoveTask(Guid taskId, TaskItemStatus newStatus)
    {
        var moveDto = new TaskItemMoveDto { Status = newStatus };
        var success = await ApiClient.MoveTaskAsync(taskId, moveDto);

        if (success)
        {
            Snackbar.Add($"Task moved to {GetStatusLabel(newStatus)}", Severity.Success);
            await LoadTasks();
        }
        else
        {
            Snackbar.Add("Failed to move task", Severity.Error);
        }
    }
}