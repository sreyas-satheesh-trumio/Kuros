@page "/project/{ProjectId:guid}"

@using Kuros.Core.DTOs.Projects
@using Kuros.Core.DTOs.TaskItems
@using Kuros.Core.Enums
@inject ApiClient ApiClient
@inject NavigationManager Navigation

<div class="project-wrapper">
    <div class="project-header">
        <button class="btn-back" @onclick="@(() => Navigation.NavigateTo("/dashboard"))">← Back</button>
        <div class="project-info">
            <h2>@project?.Name</h2>
            <p>@project?.Description</p>
        </div>
        <div class="project-actions">
            <button class="btn btn-primary" @onclick="OpenCreateTaskDialog">+ New Task</button>
            <div class="menu-dropdown">
                <button class="menu-btn">⋮</button>
                <div class="dropdown-content">
                    <a @onclick="OpenEditProjectDialog">Edit Project</a>
                    <a @onclick="DeleteProject" style="color: #ff6b6b;">Delete Project</a>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <p>Loading board...</p>
        </div>
    }
    else
    {
        <div class="kanban-board" @ondragover:preventDefault @ondrop="HandleDrop">
            @foreach (var status in TaskStatuses)
            {
                <div class="kanban-column" 
                    style="@GetColumnStyle(status)"
                    @ondragover:preventDefault
                    @ondrop="@(() => HandleDropOnColumn(status))"
                    @ondragenter:preventDefault>
                    <div class="column-header">
                        <h3 class="column-title">@GetStatusLabel(status)</h3>
                        <span class="status-count">@GetTasksForStatus(status).Count</span>
                    </div>
                    <div class="column-tasks" @key="status">
                        @foreach (var task in GetTasksForStatus(status))
                        {
                            <div class="task-card" 
                                draggable="true"
                                @ondragstart="@(() => HandleDragStart(task.Id))"
                                @ondragend="HandleDragEnd">
                                <div>
                                    <div class="task-header">
                                        <p class="task-title">@task.Title</p>
                                        <div class="task-menu">
                                            <button class="task-menu-btn" @onclick:stopPropagation
                                                @onclick="@(async () => await OpenEditTaskDialog(task))">✎</button>
                                            <button class="task-menu-btn delete-btn" @onclick:stopPropagation
                                                @onclick="@(async () => await DeleteTask(task.Id))">✕</button>
                                        </div>
                                    </div>
                                    <div class="desc">
                                        <small>@task.Description</small>
                                    </div>
                                    <div class="meta">
                                        <small>Created: @task.CreatedAt.ToString("MMM dd, yyyy")</small>
                                        <small>Updated: @task.UpdatedAt.ToString("MMM dd, yyyy")</small>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (showCreateDialog)
{
    <div class="modal-overlay" @onclick="CloseCreateDialog">
        <div class="modal-content" @onclick:stopPropagation>
            <CreateTaskDialog ProjectId="ProjectId" OnClose="CloseCreateDialog" OnSuccess="HandleTaskCreated" />
        </div>
    </div>
}

@if (showEditTaskDialog && editingTask != null)
{
    <div class="modal-overlay" @onclick="CloseEditTaskDialog">
        <div class="modal-content" @onclick:stopPropagation>
            <EditTaskDialog Task="editingTask" OnClose="CloseEditTaskDialog" OnSuccess="HandleTaskUpdated" />
        </div>
    </div>
}

@if (showEditProjectDialog && project != null)
{
    <div class="modal-overlay" @onclick="CloseEditProjectDialog">
        <div class="modal-content" @onclick:stopPropagation>
            <EditProjectDialog Project="project" OnClose="CloseEditProjectDialog" OnSuccess="HandleProjectUpdated" />
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid ProjectId { get; set; }

    private ProjectResponseDto? project;
    private List<TaskItemResponseDto>? tasks;
    private bool isLoading = true;
    private bool showCreateDialog = false;
    private bool showEditTaskDialog = false;
    private bool showEditProjectDialog = false;
    private TaskItemResponseDto? editingTask;

    private readonly TaskItemStatus[] TaskStatuses =
    {
        TaskItemStatus.BackLog,
        TaskItemStatus.ToDo,
        TaskItemStatus.InDevelopment,
        TaskItemStatus.CodeReview,
        TaskItemStatus.Done
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadProject();
        await LoadTasks();
    }

    private async Task LoadProject()
    {
        project = await ApiClient.GetProjectAsync(ProjectId);
    }

    private async Task LoadTasks()
    {
        isLoading = true;
        tasks = await ApiClient.GetTasksByProjectAsync(ProjectId);
        isLoading = false;
    }

    private List<TaskItemResponseDto> GetTasksForStatus(TaskItemStatus status)
    {
        return tasks?.Where(t => t.TaskItemStatus == status).ToList() ?? new();
    }

    private string GetStatusLabel(TaskItemStatus status) => status switch
    {
        TaskItemStatus.BackLog => "Backlog",
        TaskItemStatus.ToDo => "To Do",
        TaskItemStatus.InDevelopment => "In Development",
        TaskItemStatus.CodeReview => "Code Review",
        TaskItemStatus.Done => "Done",
        _ => status.ToString()
    };

    private string GetColumnStyle(TaskItemStatus status) => status switch
    {
        TaskItemStatus.BackLog =>
            "background: rgba(120, 120, 120, 0.12); border-color: #6b728075;",
        TaskItemStatus.ToDo =>
            "background: rgba(180, 120, 0, 0.12); border-color: #b4530975;",
        TaskItemStatus.InDevelopment =>
            "background: rgba(30, 90, 160, 0.12); border-color: #1e40af75;",
        TaskItemStatus.CodeReview =>
            "background: rgba(110, 60, 140, 0.12); border-color: #6b21a875;",
        TaskItemStatus.Done =>
            "background: rgba(40, 120, 60, 0.12); border-color: #16653475;",
        _ => ""
    };

    private void OpenCreateTaskDialog()
    {
        showCreateDialog = true;
    }

    private void CloseCreateDialog()
    {
        showCreateDialog = false;
    }

    private async Task HandleTaskCreated(TaskItemResponseDto task)
    {
        showCreateDialog = false;
        await LoadTasks();
    }

    private async Task OpenEditTaskDialog(TaskItemResponseDto task)
    {
        editingTask = task;
        showEditTaskDialog = true;
    }

    private void CloseEditTaskDialog()
    {
        showEditTaskDialog = false;
        editingTask = null;
    }

    private async Task HandleTaskUpdated(TaskItemResponseDto task)
    {
        showEditTaskDialog = false;
        editingTask = null;
        await LoadTasks();
    }

    private async Task OpenEditProjectDialog()
    {
        showEditProjectDialog = true;
    }

    private void CloseEditProjectDialog()
    {
        showEditProjectDialog = false;
    }

    private async Task HandleProjectUpdated(ProjectResponseDto updatedProject)
    {
        showEditProjectDialog = false;
        await LoadProject();
    }

    private async Task DeleteProject()
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this project? This action cannot be undone."))
        {
            var success = await ApiClient.DeleteProjectAsync(ProjectId);
            if (success)
            {
                Navigation.NavigateTo("/dashboard");
            }
        }
    }

    private async Task DeleteTask(Guid taskId)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this task?"))
        {
            var success = await ApiClient.DeleteTaskAsync(taskId);
            if (success)
            {
                await LoadTasks();
            }
        }
    }

    [Inject]
    private IJSRuntime JSRuntime { get; set; } = null!;

    private Guid? draggedTaskId;
    private ElementReference kanbanBoardRef;

    private void HandleDragStart(Guid taskId)
    {
        draggedTaskId = taskId;
        InvokeAsync(StateHasChanged);
    }

    private void HandleDragEnd()
    {
        draggedTaskId = null;
        InvokeAsync(StateHasChanged);
    }

    private async Task HandleDrop()
    {
        // Handle drops on the board itself (optional)
        await Task.CompletedTask;
    }

    private async Task HandleDropOnColumn(TaskItemStatus targetStatus)
    {
        if (draggedTaskId.HasValue)
        {
            await MoveTaskAsync(draggedTaskId.Value, targetStatus);
            draggedTaskId = null;
        }
    }

    // Enhanced MoveTaskAsync with better UX feedback
    private async Task MoveTaskAsync(Guid taskId, TaskItemStatus newStatus)
    {
        // Show loading state for specific task (optional enhancement)
        isLoading = true;
        
        try
        {
            var moveDto = new TaskItemMoveDto { Status = newStatus };
            var success = await ApiClient.MoveTaskAsync(taskId, moveDto);
            if (success)
            {
                await LoadTasks(); // Refresh all tasks
            }
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}