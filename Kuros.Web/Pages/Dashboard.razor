@page "/dashboard"
@using Kuros.Web.Services
@using Kuros.Core.DTOs.Projects
@inject ApiClient ApiClient
@inject NavigationManager Navigation

<div class="dashboard-wrapper">
    <div class="dashboard-header">
        <div>
            <h2>Projects</h2>
            <p>Manage all your projects in one place</p>
        </div>
        <button class="btn btn-primary btn-lg" @onclick="OpenCreateProjectDialog">
            + New Project
        </button>
    </div>

    <div class="search-box">
        <input type="text" @bind="searchTerm" @bind:event="oninput" placeholder="Search projects..."
            class="search-input" />
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <p>Loading projects...</p>
        </div>
    }
    else if (projects == null || projects.Count == 0)
    {
        <div class="empty-state">
            <p>No projects found. Create one to get started!</p>
        </div>
    }
    else
    {
        <div class="projects-grid">
            @foreach (var project in FilteredProjects)
            {
                <div class="project-card" @onclick="@(() => Navigation.NavigateTo($"/project/{project.Id}"))">
                    <div class="card-header">
                        <h3>@project.Name</h3>
                        <div class="card-menu">
                            <button class="menu-btn" @onclick:stopPropagation
                                @onclick="@(async () => await OpenEditProjectDialog(project))">✎</button>
                            <button class="menu-btn delete-btn" @onclick:stopPropagation
                                @onclick="@(async () => await DeleteProject(project.Id))">✕</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <p class="project-description">
                            @if (string.IsNullOrEmpty(project.Description))
                            {
                                <em>No description</em>
                            }
                            else
                            {
                                @project.Description
                            }
                        </p>
                    </div>
                    <div class="card-footer">
                        <small>Created: @project.CreatedAt.ToString("MMM dd, yyyy")</small><br>
                        <small>Updated: @project.UpdatedAt.ToString("MMM dd, yyyy")</small>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (showCreateDialog)
{
    <div class="modal-overlay" @onclick="CloseCreateDialog">
        <div class="modal-content" @onclick:stopPropagation>
            <CreateProjectDialog OnClose="CloseCreateDialog" OnSuccess="HandleProjectCreated" />
        </div>
    </div>
}

@if (showEditDialog && editingProject != null)
{
    <div class="modal-overlay" @onclick="CloseEditDialog">
        <div class="modal-content" @onclick:stopPropagation>
            <EditProjectDialog Project="editingProject" OnClose="CloseEditDialog" OnSuccess="HandleProjectUpdated" />
        </div>
    </div>
}

@code {
    private List<ProjectResponseDto>? projects;
    private string searchTerm = string.Empty;
    private bool isLoading = true;
    private bool showCreateDialog = false;
    private bool showEditDialog = false;
    private ProjectResponseDto? editingProject;

    protected override async Task OnInitializedAsync()
    {
        await LoadProjects();
    }

    private async Task LoadProjects()
    {
        isLoading = true;
        projects = await ApiClient.GetProjectsAsync();
        isLoading = false;
    }

    private List<ProjectResponseDto> FilteredProjects =>
    projects?.Where(p => p.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
    p.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
    .ToList() ?? new();

    private void OpenCreateProjectDialog()
    {
        showCreateDialog = true;
    }

    private void CloseCreateDialog()
    {
        showCreateDialog = false;
    }

    private async Task HandleProjectCreated(ProjectResponseDto project)
    {
        showCreateDialog = false;
        await LoadProjects();
    }

    private async Task OpenEditProjectDialog(ProjectResponseDto project)
    {
        editingProject = project;
        showEditDialog = true;
    }

    private void CloseEditDialog()
    {
        showEditDialog = false;
        editingProject = null;
    }

    private async Task HandleProjectUpdated(ProjectResponseDto project)
    {
        showEditDialog = false;
        editingProject = null;
        await LoadProjects();
    }

    private async Task DeleteProject(Guid projectId)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this project?"))
        {
            var success = await ApiClient.DeleteProjectAsync(projectId);
            if (success)
            {
                await LoadProjects();
            }
        }
    }

    [Inject]
    private IJSRuntime JSRuntime { get; set; } = null!;
}